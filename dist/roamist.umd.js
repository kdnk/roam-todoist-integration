var U=Object.defineProperty,_=Object.defineProperties;var j=Object.getOwnPropertyDescriptors;var b=Object.getOwnPropertySymbols;var E=Object.prototype.hasOwnProperty,N=Object.prototype.propertyIsEnumerable;var D=(d,s,m)=>s in d?U(d,s,{enumerable:!0,configurable:!0,writable:!0,value:m}):d[s]=m,O=(d,s)=>{for(var m in s||(s={}))E.call(s,m)&&D(d,m,s[m]);if(b)for(var m of b(s))N.call(s,m)&&D(d,m,s[m]);return d},$=(d,s)=>_(d,j(s));(function(d){typeof define=="function"&&define.amd?define(d):d()})(function(){"use strict";const d=async()=>{const e=window.TODOIST_TOKEN,c=roam42.common.currentActiveBlockUID(),t=(await roam42.common.getBlockInfoByUID(c))[0][0],I=(t==null?void 0:t.string).match(/\d{10}/),l="https://api.todoist.com/rest/v1/tasks/"+I+"/close",o="Bearer "+e;await fetch(l,{method:"POST",headers:{Authorization:o}});const i=t.string.replace("{{[[TODO]]}}","{{[[DONE]]}}");return await roam42.common.updateBlock(c,i),""};window.RTI=window.RTI||{},window.RTI.TODOIST_TAG_NAME=window.RTI.TODOIST_TAG_NAME||"42Todoist";const s=({task:e,project:c})=>{function f(l){const o=l.match(/\[(.*)\]\((.*)\)/);if(o){const[i,w,n]=o,r=((a,k)=>a.split(k).join(""))(l,i),p=new URL(n),g=[...w.matchAll(/\[(.[^\]\[]*)\]/g)];if(g.length>0){let a=w,k="";return g.forEach(([h,B])=>{a=a.replace(h,""),k=`${k} #[[${B}]]`}),n.includes("bts")?`${r}[${a}](${p.origin}${p.pathname}) ${k}`:`${r}[${a}](${n}) ${k}`}else return n.includes("bts")?`${r}[${w}](${p.origin}${p.pathname})`:`${r}[${w}](${n})`}else return l}let t=`${f(e.content)} [\u{1F517}](${e.url})`,u="";e.priority=="4"?u="p1":e.priority=="3"?u="p2":e.priority=="2"?u="p3":e.priority=="1"&&(u="p4"),t=`#priority/${u} ${t}`;const I=window.RTI.getTodoistId(e.url);return I&&(t=`${t} #Todoist/${I}`),e.due&&(t=`${t} [[${window.RTI.convertToRoamDate(e.due.date)}]]`),t=`${t} #[[${c.name}]] #${window.RTI.TODOIST_TAG_NAME}`,`{{[[TODO]]}} ${t} `},m=async e=>{const c=await roam42.common.currentPageUID();console.log("[util.js:79] currentPageUid: ",c);const f=await roam42.common.getBlockInfoByUID(c),u=(await window.RTI.getAllTodoistBlocksFromPageTitle(f[0][0].title)).map(l=>{const o=l[0];return window.RTI.getTodoistId(o.string)});return e.filter(l=>{const o=window.RTI.getTodoistId(l.url);return!u.includes(o)})},y=async()=>{const e="https://api.todoist.com/rest/v1/projects",c="Bearer "+TODOIST_TOKEN;return await fetch(e,{headers:{Authorization:c}}).then(t=>t.json())},R=(e,c)=>e.find(t=>t.id===c),A=async({todoistFilter:e,onlyDiff:c})=>{const f=encodeURIComponent(e),t=async()=>{const T=`https://api.todoist.com/rest/v1/tasks?filter=${f}`,r="Bearer "+window.TODOIST_TOKEN;return await fetch(T,{headers:{Authorization:r}}).then(g=>g.json())},u=async({description:T,currentBlockUid:r,currentIndent:p})=>{const g=await roam42.common.createBlock(r,p+1,"desc::");let a;const k=T.split(/\r?\n/);for(const[h,B]of k.entries())h===0?a=await roam42.common.createBlock(g,p+2,B):a=await roam42.common.createSiblingBlock(a,B)},I=await y(),l=await t();let o=l.filter(T=>!T.parent_id);c&&(o=await m(o)),o.sort((T,r)=>r.priority-T.priority);const i=l.filter(T=>T.parent_id),w=roam42.common.currentActiveBlockUID();let n=w;for(const[T,r]of o.entries()){const p=R(I,r.project_id);n=await roam42.common.createSiblingBlock(n,s({task:r,project:p}),!0),r.description&&await u({description:r.description,currentBlockUid:n,currentIndent:1});const g=i.filter(k=>k.parent_id===r.id);let a;for(const[k,h]of g.entries())k===0?a=await roam42.common.createBlock(n,1,s({task:h,project:p})):a=await roam42.common.createSiblingBlock(a,s({task:h,project:p}),!0),h.description&&await u({description:h.description,currentBlockUid:a,currentIndent:2});T===0&&await roam42.common.deleteBlock(w)}return""},S=async()=>{const e=async()=>{const o="https://api.todoist.com/rest/v1/tasks",i="Bearer "+window.TODOIST_TOKEN;return(await fetch(o,{headers:{Authorization:i}}).then(n=>n.json())).map(n=>n.id)},c=async o=>{try{return await window.roamAlphaAPI.q(`
        [:find (pull ?refs [:block/string :block/uid {:block/children ...}])
          :where [?refs :block/refs ?title][?refs :block/refs ?todoTitle][?todoTitle :node/title "TODO"][?title :node/title "${o}"]]`)}catch(i){return console.log("error in getTodoBlocksReferringToThisPage: ",i),[]}},f=async()=>(await c(window.RTI.TODOIST_TAG_NAME)).map(i=>{const w=i[0],{string:n}=w,T=n.match(/\d{10}/)[0];return $(O({},w),{todoistId:T})}),t=(o,i)=>i.filter(({todoistId:n})=>!o.includes(Number(n))),u=await e(),I=await f(),l=t(u,I);for(const o of l){const i=o.string.replace("{{[[TODO]]}}","{{[[DONE]]}}");await roam42.common.updateBlock(o.uid,i)}return""};window.RTI=$(O({},window.RTI),{completeTask:d,pullTasks:A,syncCompleted:S}),console.log("[index.ts:12] window.RTI: ",window.RTI)});
