var U=Object.defineProperty,j=Object.defineProperties;var E=Object.getOwnPropertyDescriptors;var b=Object.getOwnPropertySymbols;var P=Object.prototype.hasOwnProperty,N=Object.prototype.propertyIsEnumerable;var y=(n,s,l)=>s in n?U(n,s,{enumerable:!0,configurable:!0,writable:!0,value:l}):n[s]=l,D=(n,s)=>{for(var l in s||(s={}))P.call(s,l)&&y(n,l,s[l]);if(b)for(var l of b(s))N.call(s,l)&&y(n,l,s[l]);return n},S=(n,s)=>j(n,E(s));(function(n,s){typeof exports=="object"&&typeof module!="undefined"?s(exports):typeof define=="function"&&define.amd?define(["exports"],s):(n=typeof globalThis!="undefined"?globalThis:n||self,s(n.roamist={}))})(this,function(n){"use strict";const s=async()=>{const e=window.TODOIST_TOKEN,a=roam42.common.currentActiveBlockUID(),t=(await roam42.common.getBlockInfoByUID(a))[0][0],g=(t==null?void 0:t.string).match(/\d{10}/),T="https://api.todoist.com/rest/v1/tasks/"+g+"/close",o="Bearer "+e;await fetch(T,{method:"POST",headers:{Authorization:o}});const r=t.string.replace("{{[[TODO]]}}","{{[[DONE]]}}");return await roam42.common.updateBlock(a,r),""};window.RTI=window.RTI||{},window.RTI.TODOIST_TAG_NAME=window.RTI.TODOIST_TAG_NAME||"42Todoist";const l=({task:e,project:a})=>{function k(T){const o=T.match(/\[(.*)\]\((.*)\)/);if(o){const[r,p,i]=o,c=((d,w)=>d.split(w).join(""))(T,r),f=new URL(i),I=[...p.matchAll(/\[(.[^\]\[]*)\]/g)];if(I.length>0){let d=p,w="";return I.forEach(([h,B])=>{d=d.replace(h,""),w=`${w} #[[${B}]]`}),i.includes("bts")?`${c}[${d}](${f.origin}${f.pathname}) ${w}`:`${c}[${d}](${i}) ${w}`}else return i.includes("bts")?`${c}[${p}](${f.origin}${f.pathname})`:`${c}[${p}](${i})`}else return T}let t=`${k(e.content)} [\u{1F517}](${e.url})`,m="";e.priority=="4"?m="p1":e.priority=="3"?m="p2":e.priority=="2"?m="p3":e.priority=="1"&&(m="p4"),t=`#priority/${m} ${t}`;const g=window.RTI.getTodoistId(e.url);return g&&(t=`${t} #Todoist/${g}`),e.due&&(t=`${t} [[${window.RTI.convertToRoamDate(e.due.date)}]]`),t=`${t} #[[${a.name}]] #${window.RTI.TODOIST_TAG_NAME}`,`{{[[TODO]]}} ${t} `},A=async e=>{const a=await roam42.common.currentPageUID();console.log("[util.js:79] currentPageUid: ",a);const k=await roam42.common.getBlockInfoByUID(a),m=(await window.RTI.getAllTodoistBlocksFromPageTitle(k[0][0].title)).map(T=>{const o=T[0];return window.RTI.getTodoistId(o.string)});return e.filter(T=>{const o=window.RTI.getTodoistId(T.url);return!m.includes(o)})},_=async()=>{const e="https://api.todoist.com/rest/v1/projects",a="Bearer "+TODOIST_TOKEN;return await fetch(e,{headers:{Authorization:a}}).then(t=>t.json())},R=(e,a)=>e.find(t=>t.id===a),O=async({todoistFilter:e,onlyDiff:a})=>{const k=encodeURIComponent(e),t=async()=>{const u=`https://api.todoist.com/rest/v1/tasks?filter=${k}`,c="Bearer "+window.TODOIST_TOKEN;return await fetch(u,{headers:{Authorization:c}}).then(I=>I.json())},m=async({description:u,currentBlockUid:c,currentIndent:f})=>{const I=await roam42.common.createBlock(c,f+1,"desc::");let d;const w=u.split(/\r?\n/);for(const[h,B]of w.entries())h===0?d=await roam42.common.createBlock(I,f+2,B):d=await roam42.common.createSiblingBlock(d,B)},g=await _(),T=await t();let o=T.filter(u=>!u.parent_id);a&&(o=await A(o)),o.sort((u,c)=>c.priority-u.priority);const r=T.filter(u=>u.parent_id),p=roam42.common.currentActiveBlockUID();let i=p;for(const[u,c]of o.entries()){const f=R(g,c.project_id);i=await roam42.common.createSiblingBlock(i,l({task:c,project:f}),!0),c.description&&await m({description:c.description,currentBlockUid:i,currentIndent:1});const I=r.filter(w=>w.parent_id===c.id);let d;for(const[w,h]of I.entries())w===0?d=await roam42.common.createBlock(i,1,l({task:h,project:f})):d=await roam42.common.createSiblingBlock(d,l({task:h,project:f}),!0),h.description&&await m({description:h.description,currentBlockUid:d,currentIndent:2});u===0&&await roam42.common.deleteBlock(p)}return""},$=async()=>{const e=async()=>{const o="https://api.todoist.com/rest/v1/tasks",r="Bearer "+window.TODOIST_TOKEN;return(await fetch(o,{headers:{Authorization:r}}).then(i=>i.json())).map(i=>i.id)},a=async o=>{try{return await window.roamAlphaAPI.q(`
        [:find (pull ?refs [:block/string :block/uid {:block/children ...}])
          :where [?refs :block/refs ?title][?refs :block/refs ?todoTitle][?todoTitle :node/title "TODO"][?title :node/title "${o}"]]`)}catch(r){return console.log("error in getTodoBlocksReferringToThisPage: ",r),[]}},k=async()=>(await a(window.RTI.TODOIST_TAG_NAME)).map(r=>{const p=r[0],{string:i}=p,u=i.match(/\d{10}/)[0];return S(D({},p),{todoistId:u})}),t=(o,r)=>r.filter(({todoistId:i})=>!o.includes(Number(i))),m=await e(),g=await k(),T=t(m,g);for(const o of T){const r=o.string.replace("{{[[TODO]]}}","{{[[DONE]]}}");await roam42.common.updateBlock(o.uid,r)}return""};window.RTI={completeTask:s,pullTasks:O,syncCompleted:$},n.completeTask=s,n.pullTasks=O,n.syncCompleted=$,Object.defineProperty(n,"__esModule",{value:!0}),n[Symbol.toStringTag]="Module"});
